# 開發日誌 - 驗證系統實作紀錄

本文件紀錄了驗證系統（Authentication System）的開發進度與修改細節，方便後續回溯。

## 2025-12-26

### 17:24 | 環境準備
- 安裝 `bcryptjs` 及其類型定義，用於密碼雜湊處理。
- 建立 `types/auth.d.ts` 定義全域驗證相關類型。

### 17:53 | 資料庫模型分析
- 分析 `models/user.model.ts` 與 `models/account.model.ts`。
- 確認 `Account` 模型中的 `password` 為非必填，以支援 OAuth 登入。

### 17:58 | 註冊功能實作 (Credentials)
- 建立 `lib/actions/auth.action.ts`。
- 實作 `signUpWithCredentials` Server Action：
    - 使用 Zod 進行資料驗證。
    - 使用 `bcryptjs` 進行密碼雜湊。
    - 使用 Mongoose Session 處理交易（Transaction），確保 User 與 Account 同時建立成功。
- 更新 `app/(auth)/sign-up/page.tsx` 整合註冊 Action。

### 18:02 | 登入功能實作 (Credentials)
- 更新 `auth.ts`：
    - 加入 `CredentialsProvider`。
    - 實作 `authorize` 邏輯：驗證 Email、比對雜湊密碼。
    - 設定 `jwt` 與 `session` callbacks，將資料庫 ID 傳遞至前端。
- 更新 `app/(auth)/sign-in/page.tsx` 整合 NextAuth `signIn` 方法。

### 18:06 | 資料驗證工具
- 建立 `scripts/check-users.js`，用於直接從終端機檢查 MongoDB 中的使用者與帳號資料。

### 18:13 | 錯誤修復
- 修復 `lib/actions/auth.action.ts` 中的 `MongoTransactionError`。
- 優化交易處理邏輯，確保在 `commitTransaction` 後不會重複呼叫 `abortTransaction`。

## 2025-12-29

### 08:43 | OAuth 使用者自動同步
- 更新 `auth.ts`：
    - 加入 `signIn` callback：當使用者透過 Google 登入時，若資料庫無此使用者，則自動建立 `User` 與 `Account` 紀錄。
    - 優化 `session` callback：確保 OAuth 登入後，`session.user.id` 能正確對應到 MongoDB 的 `_id`。

## 2025-12-30

### 17:13 | 儀表板導航功能
- 更新 `components/sidebar/SidebarDashboard.tsx`：
    - 導入 `useRouter` 實作程式化導航。
    - 為「Leave Dashboard」按鈕新增點擊事件，跳轉至首頁 `/`。

### 17:25 | 儀表板狀態管理優化
- 實作「狀態提升 (Lifting State Up)」邏輯：
    - 更新 `app/(uploadAndDashboard)/dashboard/[id]/page.tsx`：修改 `handleOnSelect` 接收參數並更新 `selected` 狀態。
    - 更新 `components/sidebar/SidebarDashboard.tsx`：新增 `onSelect` prop 並傳遞至子組件。
    - 更新 `components/buttons/DashboardButton.tsx`：接收 `onSelect` 並在點擊時回傳按鈕標籤。

### 17:41 | 側邊欄按鈕樣式與互動修復
- 更新 `components/buttons/DashboardButton.tsx`：
    - **動態樣式**：實作 `isSelected` 邏輯，根據 `currentSelect` 狀態動態切換按鈕背景色與文字顏色。
    - **互動修復**：移除外層 `div` 的 `pointer-events-none`，確保按鈕可被點擊。
    - **優先級修復**：解決 CSS Specificity 問題，將動態顏色直接套用於 `icon` 與 `button` 元素，避免被預設顏色覆蓋。

### 17:55 | 移除 SASS 依賴
- 更新 `package.json`：移除 `sass` 套件，全面轉向 Tailwind CSS 4.0。
- 清理專案結構，確認無殘留 `.scss` 檔案。

### 18:10 | 背景動畫系統 (Blobs) 實作
- 建立 `components/blobs/SidebarBlobs.tsx` 與 `BackgroundBlobs.tsx`。
- 在 `app/globals.css` 定義 `@keyframes moveShape`：
    - 實作 18 秒長週期的緩慢漂浮動畫。
    - 使用 `cubic-bezier(0.445, 0.05, 0.55, 0.95)` 達成自然律動。
    - 設定 `alternate` 確保動畫循環平滑無接縫。

### 18:30 | 佈局定位與 CSS 渲染修正
- **定位修正**：將背景圓球從 `fixed` 改為 `absolute`，並在父容器加上 `relative`，解決 `overflow-hidden` 無法裁切的問題。
- **渲染修正**：解決 `inset shadow` 被子元素背景遮擋問題，改用 `absolute inset-0 pointer-events-none` 遮罩層實作。
- **Flex 修正**：修復 `SidebarDashboard.tsx` 中 `gap` 失效問題（補上 `flex` 類別）。

### 18:50 | 驗證系統與資料獲取優化
- **Session 擴充**：更新 `auth.ts` 與 `types/auth.d.ts`，將 `user.role` 整合進 JWT 與 Session。
- **架構優化建議**：針對 Dashboard 設定頁面，提倡使用 Server Action (`getUserProfile`) 獲取即時資料，而非單純依賴 Session 快照，以提升資料準確性與安全性。