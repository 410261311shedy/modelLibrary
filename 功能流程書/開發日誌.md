# 開發日誌 - 驗證系統實作紀錄

本文件紀錄了驗證系統（Authentication System）的開發進度與修改細節，方便後續回溯。

## 2025-12-26

### 17:24 | 環境準備
- 安裝 `bcryptjs` 及其類型定義，用於密碼雜湊處理。
- 建立 `types/auth.d.ts` 定義全域驗證相關類型。

### 17:53 | 資料庫模型分析
- 分析 `models/user.model.ts` 與 `models/account.model.ts`。
- 確認 `Account` 模型中的 `password` 為非必填，以支援 OAuth 登入。

### 17:58 | 註冊功能實作 (Credentials)
- 建立 `lib/actions/auth.action.ts`。
- 實作 `signUpWithCredentials` Server Action：
    - 使用 Zod 進行資料驗證。
    - 使用 `bcryptjs` 進行密碼雜湊。
    - 使用 Mongoose Session 處理交易（Transaction），確保 User 與 Account 同時建立成功。
- 更新 `app/(auth)/sign-up/page.tsx` 整合註冊 Action。

### 18:02 | 登入功能實作 (Credentials)
- 更新 `auth.ts`：
    - 加入 `CredentialsProvider`。
    - 實作 `authorize` 邏輯：驗證 Email、比對雜湊密碼。
    - 設定 `jwt` 與 `session` callbacks，將資料庫 ID 傳遞至前端。
- 更新 `app/(auth)/sign-in/page.tsx` 整合 NextAuth `signIn` 方法。

### 18:06 | 資料驗證工具
- 建立 `scripts/check-users.js`，用於直接從終端機檢查 MongoDB 中的使用者與帳號資料。

### 18:13 | 錯誤修復
- 修復 `lib/actions/auth.action.ts` 中的 `MongoTransactionError`。
- 優化交易處理邏輯，確保在 `commitTransaction` 後不會重複呼叫 `abortTransaction`。

## 2025-12-29

### 08:43 | OAuth 使用者自動同步
- 更新 `auth.ts`：
    - 加入 `signIn` callback：當使用者透過 Google 登入時，若資料庫無此使用者，則自動建立 `User` 與 `Account` 紀錄。
    - 優化 `session` callback：確保 OAuth 登入後，`session.user.id` 能正確對應到 MongoDB 的 `_id`。

## 2025-12-30

### 17:13 | 儀表板導航功能
- 更新 `components/sidebar/SidebarDashboard.tsx`：
    - 導入 `useRouter` 實作程式化導航。
    - 為「Leave Dashboard」按鈕新增點擊事件，跳轉至首頁 `/`。

### 17:25 | 儀表板狀態管理優化
- 實作「狀態提升 (Lifting State Up)」邏輯：
    - 更新 `app/(uploadAndDashboard)/dashboard/[id]/page.tsx`：修改 `handleOnSelect` 接收參數並更新 `selected` 狀態。
    - 更新 `components/sidebar/SidebarDashboard.tsx`：新增 `onSelect` prop 並傳遞至子組件。
    - 更新 `components/buttons/DashboardButton.tsx`：接收 `onSelect` 並在點擊時回傳按鈕標籤。

### 17:41 | 側邊欄按鈕樣式與互動修復
- 更新 `components/buttons/DashboardButton.tsx`：
    - **動態樣式**：實作 `isSelected` 邏輯，根據 `currentSelect` 狀態動態切換按鈕背景色與文字顏色。
    - **互動修復**：移除外層 `div` 的 `pointer-events-none`，確保按鈕可被點擊。
    - **優先級修復**：解決 CSS Specificity 問題，將動態顏色直接套用於 `icon` 與 `button` 元素，避免被預設顏色覆蓋。

### 17:55 | 移除 SASS 依賴
- 更新 `package.json`：移除 `sass` 套件，全面轉向 Tailwind CSS 4.0。
- 清理專案結構，確認無殘留 `.scss` 檔案。

### 18:10 | 背景動畫系統 (Blobs) 實作
- 建立 `components/blobs/SidebarBlobs.tsx` 與 `BackgroundBlobs.tsx`。
- 在 `app/globals.css` 定義 `@keyframes moveShape`：
    - 實作 18 秒長週期的緩慢漂浮動畫。
    - 使用 `cubic-bezier(0.445, 0.05, 0.55, 0.95)` 達成自然律動。
    - 設定 `alternate` 確保動畫循環平滑無接縫。

### 18:30 | 佈局定位與 CSS 渲染修正
- **定位修正**：將背景圓球從 `fixed` 改為 `absolute`，並在父容器加上 `relative`，解決 `overflow-hidden` 無法裁切的問題。
- **渲染修正**：解決 `inset shadow` 被子元素背景遮擋問題，改用 `absolute inset-0 pointer-events-none` 遮罩層實作。
- **Flex 修正**：修復 `SidebarDashboard.tsx` 中 `gap` 失效問題（補上 `flex` 類別）。

### 18:50 | 驗證系統與資料獲取優化
- **Session 擴充**：更新 `auth.ts` 與 `types/auth.d.ts`，將 `user.role` 整合進 JWT 與 Session。
- **架構優化建議**：針對 Dashboard 設定頁面，提倡使用 Server Action (`getUserProfile`) 獲取即時資料，而非單純依賴 Session 快照，以提升資料準確性與安全性。

## 2026-01-02

### 15:40 | BIM 3D 視圖環境建構 (That Open Engine)

Feature: BIM 3D Viewer Environment Setup
  As a developer
  I want to integrate That Open Engine into the Next.js project
  So that I can render and interact with IFC/FRAG models

  Scenario: Initialize OBC Components and Worlds
    Given the project has installed "@thatopen/components", "@thatopen/fragments", and "three@0.175.0"
    When the IFCViewer component mounts
    Then an OBC.Components instance is created
    And a World is initialized with SimpleScene, OrthoPerspectiveCamera, and SimpleRenderer
    And the renderer is attached to the container DOM element

  Scenario: Configure IFC Loader with WASM
    Given the OBC.Components instance is initialized
    When the IfcLoader module is requested
    Then the WASM path is set to "https://unpkg.com/web-ifc@0.0.72/"
    And autoSetWasm is disabled for manual control

### 16:15 | 模型上傳流程實作 (Step 1 & 2)

Feature: Model Upload and Preview Workflow
  As a user
  I want to upload BIM files and select a cover image
  So that I can create a model card for the library

  Scenario: File Upload and Type Detection (Step 1)
    Given the user is on the Model Upload step
    When the user drops an ".ifc" or ".frag" file into the sidebar
    Then the file is categorized as "3d" type
    And the Viewer3D component is rendered to display the model
    When the user drops a ".pdf" file
    Then the file is categorized as "pdf" type
    And the PDFViewer component is rendered to display the drawing

  Scenario: Optimized 3D Model Loading
    Given a 3D model file is selected
    When the Viewer3D component receives the file prop
    Then FragmentsManager initializes with the worker path "https://unpkg.com/@thatopen/fragments@3.1.0/dist/Worker/worker.mjs"
    And the file is read as ArrayBuffer and loaded via IfcLoader or FragmentsManager
    And the model is added to the scene and the camera fits to the model's sphere

  Scenario: Cover Image Capture (Step 2)
    Given the user has loaded a model and proceeded to "Cover Selection"
    And a red capture frame is displayed over the viewer
    When the user clicks the "Next" button
    Then the Viewer3D.takeScreenshot() method is called via ref
    And the current canvas content is captured as a base64 PNG string
    And the screenshot is stored as the model's cover image

### 16:40 | 技術細節與優化紀錄
- **套件版本同步**：強制安裝 `@thatopen/components@~3.1.0` 系列，解決 `fragments.core` 類型定義不一致的問題。
- **初始化順序優化**：確保 `components.init()` 在所有 Loader 與 World 配置完成後才執行，避免渲染黑屏。
- **資源釋放**：在 `useEffect` 清理函數中呼叫 `components.dispose()`，防止 3D 引擎造成的記憶體洩漏。
- **組件通訊**：使用 `forwardRef` 與 `useImperativeHandle` 讓父元件能跨組件觸發 3D 截圖功能。

### 15:50 | 全域無障礙 (Accessibility) 優化
- **修復控制台警告**：針對 `installHook.js` 報出的標籤遺漏警告，進行全方位修復。
- **新增 aria-label**：
    - `SearchBar.tsx`：為搜尋輸入框與圖標按鈕添加描述。
    - `ThemeSwitcher.tsx` & `SetLanguageButton.tsx`：為切換開關與下拉按鈕添加標籤。
    - `AuthForms.tsx`：為密碼顯示/隱藏按鈕添加動態標籤。
    - `ModelUploadSidebar.tsx` & `SidebarDashboard.tsx`：為收合、移除及導航按鈕添加標籤。
    - `ModelCard.tsx`：為下載與收藏按鈕添加包含模型名稱的標籤。
    - `SocialAuthForm.tsx` & `LogoutButton.tsx`：為登入/登出按鈕添加標籤。

### 16:56 | 檔案上傳偵測優化
- **新增偵測日誌**：在 `ModelUploadSidebar.tsx` 添加 `console.log`，即時顯示上傳檔案的副檔名（.ifc, .frag, .pdf）與系統判定類型，確保 `.frag` 檔案能被正確識別。

### 17:24 | 3D 視圖運行時錯誤修復 (Fragments Worker)
- **修復 Fragments 錯誤**：解決 `Fragments: Error fetching thread!` 導致模型無法載入的問題。
- **Worker 部署優化**：
    - 將 `worker.mjs` 從 `node_modules` 部署至 `public/worker.mjs`，確保瀏覽器可正確存取。
    - 更新 `Viewer3D.tsx` 中的 `fragments.init` 路徑為 `/worker.mjs`。
- **調試與類型修復**：
    - 在 `Viewer3D.tsx` 添加初始化與載入狀態日誌。
    - 修復 `Viewer3D.tsx` 中的 ESLint `any` 類型警告與 `ts-expect-error` 指令。

## 2026-01-05

### 09:00 | 模型上傳流程優化與 Step 3 基礎建設

Feature: Model Upload UX and Metadata Integration
  As a user
  I want a clear visual guide for cover capture and a professional form for metadata
  So that I can accurately document my BIM models

  Scenario: Visual Guidance for Cover Capture (Step 2)
    Given the user is in the "Cover Selection" step
    Then a red bounding box (aspect-video) is displayed in the center of the viewer
    And an instruction overlay appears at the top
    When the user clicks "Next", the 3D engine forces a re-render before capturing the canvas to ensure no black frames

  Scenario: Metadata Form Implementation (Step 3)
    Given the user has captured a cover image
    When the user proceeds to the "Metadata" step
    Then the MetadataForm is rendered with the captured image as a preview
    And the form includes fields for Title, Category, Keywords, and Description
    And the form supports Permission settings (Standard/Private) and Team association

### 09:15 | 技術細節與介面優化
- **截圖邏輯強化**：在 `Viewer3D.tsx` 的 `takeScreenshot` 中加入 `renderer.three.render` 調用，確保 WebGL 緩衝區在讀取前已更新。
- **多層陰影裝飾**：在 `upload/page.tsx` 使用 `absolute inset-0 pointer-events-none` 實作複雜的內凹陰影（inset shadow），增加介面的工業設計感。
- **組件解耦**：將 Metadata 表單獨立為 `MetadataForm.tsx`，並使用 HeroUI (原 NextUI) 提升開發效率與 UI 一致性。

## 2026-01-09

### 09:00 | 導航系統與 MegaMenu 整合
- **實作 MegaMenu**：建立 `components/MegaMenu.tsx`，支援按類別（Buildings, Products, Elements 等）篩選模型卡片。
- **Navbar 整合**：在 `Navbarhead.tsx` 中整合 MegaMenu，並透過 `SearchBar` 的切換按鈕控制顯示。
- **動畫優化**：使用 Tailwind CSS 實作平滑的展開/收合動畫（`max-h` 與 `opacity` 轉換）。

### 09:30 | 3D 引擎架構模組化 (That Open Engine)
- **架構拆分**：將 3D 引擎初始化邏輯移至 `components/bim-components/setup/src/`，提升程式碼可維護性。
- **核心功能實作**：
    - `create-world.ts`：實作透明背景、BUI Viewport 整合及自動 Resize 監聽。
    - `ifc-loader.ts`：手動配置 WASM 路徑，確保 IFC 解析穩定性。
    - `fragments-manager.ts`：整合 Web Worker 處理大型模型載入。

### 10:00 | 模型上傳互動功能增強
- **側邊欄功能擴充**：在 `ModelUploadSidebar.tsx` 新增以下功能：
    - **模型聚焦 (Focus)**：支援單一模型或全場景聚焦。
    - **模型匯出 (Export)**：支援將載入的 IFC 轉換並匯出為 `.frag` 格式。
    - **模型刪除**：同步從 3D 場景與上傳列表中移除模型。
- **UX 優化**：在 `upload/page.tsx` 加入 `IFCProcessingStatus` 全螢幕載入遮罩，在解析 IFC 時提供明確的視覺回饋。

### 10:30 | Metadata 表單與 UI 完善
- **表單實作**：在 `MetadataForm.tsx` 中使用 HeroUI 組件建立完整的元數據輸入介面，包含標題、類別、關鍵字、描述及權限設定。
- **封面預覽**：整合 Step 2 擷取的封面圖片至表單預覽區域。
- **視覺風格統一**：全站應用 `shadow-[inset_...]` 內凹陰影與 `BackgroundBlobs` 動畫，強化專案的工業科技感。

### 09:35 | 環境修復紀錄
- **修復缺失套件**：發現 `package.json` 中缺失 `@thatopen` 相關套件與 `three`，已重新安裝並鎖定版本（`@thatopen/components@~3.1.0`, `@thatopen/components-front@~3.1.0`, `three@0.175.0`），確保 3D 視圖功能正常運作。